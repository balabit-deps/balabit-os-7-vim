Backported of:

From ec66c41d84e574baf8009dbc0bd088d2bc5b2421 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 11 Oct 2019 21:19:13 +0200
Subject: [PATCH] patch 8.1.2136: using freed memory with autocmd from fuzzer

Problem:    using freed memory with autocmd from fuzzer. (Dhiraj Mishra,
            Dominique Pelle)
Solution:   Avoid using "wp" after autocommands. (closes #5041)
diff --git a/src/testdir/test_autocmd.vim b/src/testdir/test_autocmd.vim
index b7d43b5..8b999cd 100644
--- a/src/testdir/test_autocmd.vim
+++ b/src/testdir/test_autocmd.vim
@@ -125,6 +125,14 @@ func Test_autocmd_bufunload_avoiding_SEGV_01()
   bwipe! bb.txt
 endfunc
 
+func Test_autocmd_was_using_freed_memory()
+  pedit xx
+  n x
+  au WinEnter * quit
+  split
+  au! WinEnter
+endfunc
+
 " SEGV occurs in older versions.  (At least 7.4.2321 or older)
 func Test_autocmd_bufunload_avoiding_SEGV_02()
   setlocal buftype=nowrite
diff --git a/src/window.c b/src/window.c
index 669f3bd..d7b001a 100644
--- a/src/window.c
+++ b/src/window.c
@@ -4435,6 +4435,11 @@ win_enter_ext(
     maketitle();
 #endif
     curwin->w_redr_status = TRUE;
+#ifdef FEAT_TERMINAL
+    if (bt_terminal(curwin->w_buffer))
+ 	// terminal is likely in another mode
+ 	redraw_mode = TRUE;
+#endif
     redraw_tabline = TRUE;
     if (restart_edit)
 	redraw_later(VALID);	/* causes status line redraw */
